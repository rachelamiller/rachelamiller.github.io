<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real or Fake Headline Runner</title>
    <!-- Imports the Three.js 3D library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* --- Basic Setup --- */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #0d0d1e; /* Dark blue space background */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        canvas { 
            display: block; 
        }

        /* --- UI Overlay --- */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; /* Used to center the message box */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        
        #message-box {
            background-color: rgba(0, 0, 0, 0.85);
            padding: 25px 35px;
            border-radius: 15px;
            border: 3px solid #00ffff; /* Cyan border */
            box-shadow: 0 0 35px rgba(0, 255, 255, 0.6);
            pointer-events: auto; /* This box *can* be clicked */
            max-width: 90%;
            transition: opacity 0.3s ease-in-out;
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 800px;
            max-width: 90%;
            opacity: 0;
            display: none;
            z-index: 10;
        }

        /* --- Text Elements --- */
        .title { 
            font-size: 2.8em; 
            color: #00ffff; 
            margin-bottom: 10px; 
            font-weight: bold;
            text-shadow: 0 0 10px #00ffff;
        }
        
        #headline-display {
            font-size: 1.4em;
            font-weight: bold;
            color: #ffcc00; /* Yellow */
            margin-bottom: 20px;
            min-height: 50px;
            text-shadow: 0 0 5px #ff6600;
            line-height: 1.4;
        }

        .subtitle { 
            font-size: 1.1em; 
            margin-bottom: 20px; 
            color: #cccccc;
        }
        
        #final-score {
            font-size: 1.8em; 
            margin-bottom: 15px;
            color: #00ff00; /* Green score */
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        
        /* --- In-Game Score --- */
        #score-display, #high-score-display {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.8em;
            color: #00ff00;
            font-weight: bold;
            text-shadow: 0 0 8px #000000;
            opacity: 0; /* Hidden until game starts */
            transition: opacity 0.5s;
        }
        #high-score-display {
            top: 55px;
            color: #00ffff;
            font-size: 1.2em;
        }

        /* --- Button --- */
        .button {
            background-color: #00ffff;
            color: #0d0d1e;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            margin-top: 15px;
        }
        .button:hover {
            background-color: #00b3b3;
            transform: translateY(-2px); /* Slight lift on hover */
        }

        /* --- Instructions --- */
        .instructions {
            margin-top: 25px;
            font-size: 1.1em;
            color: #cccccc;
            line-height: 1.5;
        }
        .instructions span {
            color: #ff6600; /* Orange highlight */
            font-weight: bold;
        }

        /* --- Mobile Responsive Design --- */
        @media (max-width: 600px) {
            .title { font-size: 2em; }
            #headline-display { font-size: 1.2em; }
            .subtitle { font-size: 1em; }
            .button { font-size: 1em; padding: 10px 20px; }
            .instructions { font-size: 0.9em; }
            #score-display, #high-score-display { font-size: 1em; left: 10px; top: 10px;}
            #high-score-display { top: 35px; }
        }
    </style>
</head>
<body>
    <!-- This div holds all the UI text, buttons, and scores -->
    <div id="overlay">
        <div id="message-box-content" style="text-align: center;">
            <div class="title">REAL OR FAKE RUNNER</div>
            <div id="status-message" class="subtitle">Press Start to begin.</div>
            <div id="final-score"></div>
            <button id="start-button" class="button">Start Game</button>
            <div class="instructions">
                Use **Left Arrow (←)** for <span>FAKE</span> news.<br>
                Use **Right Arrow (→)** for <span>REAL</span> news.
                <br>
                Use **Down Arrow (↓)** for the <span>CENTER LANE</span> (safe zone).
            </div>
        </div>
    </div>

    <!-- The in-game headline display -->
    <div id="message-box">
        <div id="headline-display"></div>
        <div id="status-message-ingame" class="subtitle" style="margin-bottom: 0;"></div>
    </div>
    
    <!-- These are separate for in-game display -->
    <div id="score-display">Score: 0</div>
    <div id="high-score-display">High Score: 0</div>

    <script>
        // --- 1. HEADLINES DATA ---
        // A large pool of 60 headlines (30 Real, 30 Fake) to ensure long gameplay without repetition.
        const HEADLINES = [
          { "headline": "A Town in Italy Has Outlawed the Wearing of Flip-Flops.", "isReal": true },
          { "headline": "Scientists Are Training Dogs to Sniff Out Computer Hard Drives.", "isReal": true },
          { "headline": "Finland's Air Force Removed a Swastika from Its Official Emblem.", "isReal": true },
          { "headline": "A Study Found That Talking to Your Plants Actually Helps Them Grow Faster.", "isReal": true },
          { "headline": "A Man Was Arrested for Trying to Break Into an ATM Machine.", "isReal": true },
          { "headline": "The U.S. Navy Successfully Tested a Laser Weapon That Can Shoot Down Drones.", "isReal": true },
          { "headline": "Engineers Developed a Battery Powered by Snowfall.", "isReal": true },
          { "headline": "Scientists in Russia Claim to Have Discovered the World's Oldest Water.", "isReal": true },
          { "headline": "An Entire City in the Netherlands Is Powered by Cheese Waste.", "isReal": true },
          { "headline": "Norway Once Knighted a King Penguin Named Nils Olav.", "isReal": true },
          { "headline": "A French town successfully trained eagles to intercept and destroy unauthorized drones.", "isReal": true },
          { "headline": "Cows in Germany were fitted with VR headsets to make them think they are in a summer meadow.", "isReal": true },
          { "headline": "Archaeologists discovered a fully preserved, 2000-year-old Roman fast-food stall in Pompeii.", "isReal": true },
          { "headline": "The United Nations officially recognized pizza as a cultural heritage item.", "isReal": true },
          { "headline": "Researchers invented a new type of transparent wood that could replace glass.", "isReal": true },
          { "headline": "The world's longest traffic jam lasted 10 days and spanned over 60 miles in China.", "isReal": true },
          { "headline": "A woman survived 14 days in the Australian wilderness by eating only ants and plants.", "isReal": true },
          { "headline": "Scientists successfully taught spineless sea slugs how to swim using only light.", "isReal": true },
          { "headline": "Japan built a giant vacuum cleaner to clear space debris orbiting Earth.", "isReal": true },
          { "headline": "A library in Finland sends out books by drone to remote island residents.", "isReal": true },
          { "headline": "Iceland officially bans the use of the name \"Kylie\" because it's not a traditional name.", "isReal": true },
          { "headline": "A hotel in the Maldives features a fully submerged underwater bedroom.", "isReal": true },
          { "headline": "Scientists discovered a new species of insect that pollinates underwater.", "isReal": true },
          { "headline": "A man in the UK legally changed his name to \"Captain Fantastic Faster Than Superman Spiderman Batman Wolverine Hulk and The Flash Combined.\".", "isReal": true },
          { "headline": "South Korea announced plans to build an enormous floating city by 2030.", "isReal": true },
          { "headline": "A team of engineers designed a backpack that converts heat from walking into electricity.", "isReal": true },
          { "headline": "A rare blue lobster was found by a fisherman off the coast of Maine.", "isReal": true },
          { "headline": "The official language of Paraguay is both Spanish and Guarani.", "isReal": true },
          { "headline": "A space agency is growing tomatoes using conditions similar to those on Mars.", "isReal": true },
          { "headline": "The sound of crickets chirping can be used to estimate the temperature.", "isReal": true },
          
          { "headline": "SpaceX Announces Plans to Launch a Luxury Hotel into Earth’s Orbit.", "isReal": false },
          { "headline": "New App Uses AI to Translate Your Cat's Meows into Sarcastic Human Speech.", "isReal": false },
          { "headline": "Study Finds That Taking Too Many Selfies Is Linked to a Rare Mental Condition.", "isReal": false },
          { "headline": "A Town in Wyoming Elected a Goat as Its Honorary Mayor.", "isReal": false },
          { "headline": "Scientists Have Designed a New Type of \"Forever\" Plastic That Can Dissolve in Water.", "isReal": false },
          { "headline": "World’s Largest Library Is Now Offering Human Librarians as \"Book Recommendations.\"", "isReal": false },
          { "headline": "Germany Passes a Law Requiring All New Homes to Be Built with Rooftop Gardens.", "isReal": false },
          { "headline": "Google AI Accidentally Creates a New, More Efficient Type of Concrete.", "isReal": false },
          { "headline": "A New York City Restaurant Is Charging $50 to Keep Your Phone Off the Table.", "isReal": false },
          { "headline": "Scientists Discover a New Mineral That Generates Electricity When Exposed to Jazz Music.", "isReal": false },
          { "headline": "Due to safety concerns, all circular kitchen tables are being recalled worldwide.", "isReal": false },
          { "headline": "NASA confirmed that the moon is slowly turning green due to accumulated space moss.", "isReal": false },
          { "headline": "New evidence suggests historical Vikings actually used rubber ducks as navigation tools.", "isReal": false },
          { "headline": "The Pope announced that all Catholic churches must switch to solar-powered stained glass windows.", "isReal": false },
          { "headline": "Researchers developed a sugar substitute that makes desserts taste like fresh pavement.", "isReal": false },
          { "headline": "World leaders passed a treaty requiring everyone to wear socks on their hands while sleeping.", "isReal": false },
          { "headline": "A popular coffee chain begins offering coffee beans grown exclusively in Antarctica's sub-zero caves.", "isReal": false },
          { "headline": "Archaeologists found a giant, perfectly preserved chocolate bar from the 18th century.", "isReal": false },
          { "headline": "California mandates that all household pets must have individual Instagram accounts with daily posts.", "isReal": false },
          { "headline": "A study found that the average human sheds exactly 15 pounds of skin per year in their sleep.", "isReal": false },
          { "headline": "Scientists claim they have invented a pill that allows humans to communicate directly with earthworms.", "isReal": false },
          { "headline": "Japan introduced a 100-story, fully automated vending machine that dispenses cars.", "isReal": false },
          { "headline": "A major tech company replaced its entire customer service department with a single philosophical octopus.", "isReal": false },
          { "headline": "It is now illegal to wear stripes and polka dots at the same time in three U.S. states.", "isReal": false },
          { "headline": "A new species of jellyfish was discovered that can perfectly mimic the sound of a doorbell.", "isReal": false },
          { "headline": "Researchers developed a special paint that allows walls to listen to and correct grammatical errors in conversations.", "isReal": false },
          { "headline": "A popular soft drink company announced a limited-edition flavor based on the scent of fresh printer ink.", "isReal": false },
          { "headline": "The world's largest rubber band ball spontaneously combusted during a charity event.", "isReal": false },
          { "headline": "All professional athletes must now compete while balancing a fruit basket on their head.", "isReal": false },
          { "headline": "The world's smallest piano can only be played by micro-organisms, scientists confirm.", "isReal": false }
        ];

        // --- 2. THREE.JS SCENE SETUP ---
        let scene, camera, renderer, player;
        const TILE_WIDTH = 5;
        const TILE_DEPTH = 30; 
        const TILE_HEIGHT = 0.5;
        const LANE_WIDTH = 5; 
        const LANE_POSITIONS = [-LANE_WIDTH, 0, LANE_WIDTH];
        const LANE_MAP = { 0: 'FAKE', 2: 'REAL' };

        let tiles = []; 
        let score = 0;
        
        // --- Game State Refactored ---
        let gameState = 'menu'; // 'menu', 'running', 'animating', 'over'
        const HIGH_SCORE_THRESHOLD = 10;
        let endAnimationStartTime = 0;
        const endAnimationDuration = 3; // 3 seconds of celebration/failure
        let endAnimationType = 'fail'; // 'celebrate' or 'fail'

        let currentLane = 1; 
        let playerSpeed = 0.4; 
        let headlineQueue = []; 
        let nextHeadlineTileZ = -TILE_DEPTH; 

        const HEADLINE_ADVANCE_DISTANCE = TILE_DEPTH * 4;
        const TILE_COUNT = 15;

        // --- DOM Elements ---
        const overlay = document.getElementById('overlay');
        const messageBox = document.getElementById('message-box');
        const startButton = document.getElementById('start-button');
        const headlineDisplay = document.getElementById('headline-display');
        const statusMessage = document.getElementById('status-message');
        const statusMessageIngame = document.getElementById('status-message-ingame');
        const scoreDisplay = document.getElementById('score-display');
        const finalScoreDisplay = document.getElementById('final-score');
        const highScoreDisplay = document.getElementById('high-score-display');

        // --- Game State Movement ---
        let currentHeadline = null; 
        let isMoving = false; 
        let targetX = 0; 
        let moveStartTime = 0;
        const moveDuration = 0.15; 

        // --- High Score Management (using localStorage) ---
        const HIGH_SCORE_KEY = 'headlineRunnerHighScore';

        function getHighScore() {
            return parseInt(localStorage.getItem(HIGH_SCORE_KEY) || '0', 10);
        }

        function setHighScore(newScore) {
            const oldHighScore = getHighScore();
            if (newScore > oldHighScore) {
                localStorage.setItem(HIGH_SCORE_KEY, newScore.toString());
                highScoreDisplay.textContent = `High Score: ${newScore}`;
            }
        }

        // --- Journalist Model Function ---

        /**
         * Creates a composite 3D model of a figure resembling a journalist.
         */
        function createJournalist() {
            const group = new THREE.Group();
            
            // 1. Body (Jacket/Suit)
            const bodyGeometry = new THREE.BoxGeometry(1.2, 2.5, 1);
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0x1a1a1a, shininess: 50 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 1.25; 
            group.add(body);

            // 2. Head
            const headGeometry = new THREE.SphereGeometry(0.4, 16, 16);
            const headMaterial = new THREE.MeshPhongMaterial({ color: 0xffe0bd, shininess: 80 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 2.8;
            group.add(head);
            
            // 3. Microphone
            const micGroup = new THREE.Group();
            
            const handleGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.5, 12);
            const handleMaterial = new THREE.MeshPhongMaterial({ color: 0xcccccc });
            const handle = new THREE.Mesh(handleGeometry, handleMaterial);
            handle.position.y = 0.25;
            micGroup.add(handle);

            const micHeadGeometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
            const micHeadMaterial = new THREE.MeshPhongMaterial({ color: 0xff6600 });
            const micHead = new THREE.Mesh(micHeadGeometry, micHeadMaterial);
            micHead.position.y = 0.5;
            micGroup.add(micHead);
            
            micGroup.position.set(0.6, 2.3, 0.2);
            micGroup.rotation.z = Math.PI / 4;
            
            group.add(micGroup);
            
            return group;
        }


        // --- 3. CORE GAME FUNCTIONS ---

        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x0d0d1e, 1, TILE_DEPTH * TILE_COUNT * 0.4);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 4.5, 8); 
            camera.rotation.x = -Math.PI / 8;

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Lighting
            const ambient = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambient);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(0, 10, 5);
            scene.add(directionalLight);

            // Player
            player = createJournalist();
            player.position.set(LANE_POSITIONS[currentLane], 0, 0); 
            scene.add(player);

            // Load high score
            highScoreDisplay.textContent = `High Score: ${getHighScore()}`;

            // Initialize the tunnel
            for (let i = 0; i < TILE_COUNT; i++) {
                addTile(i * -TILE_DEPTH);
            }

            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', onKeyDown);
            startButton.addEventListener('click', startGame);
            
            // Set initial overlay state
            overlay.style.display = 'flex';
            messageBox.style.display = 'none';
            statusMessage.textContent = "Press Start to begin. Choose Real or Fake to survive!";

            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function startGame() {
            // Reset state
            gameState = 'running';
            score = 0;
            currentLane = 1;
            player.position.x = LANE_POSITIONS[currentLane];
            player.position.z = 0;
            player.rotation.set(0, 0, 0); // Reset character rotation
            playerSpeed = 0.4;
            nextHeadlineTileZ = -TILE_DEPTH;
            headlineQueue = [];
            currentHeadline = null;

            // Clear old tiles and reset
            tiles.forEach(tile => scene.remove(tile));
            tiles = [];
            for (let i = 0; i < TILE_COUNT; i++) {
                addTile(i * -TILE_DEPTH);
            }

            // UI updates
            overlay.style.display = 'none';
            messageBox.style.display = 'block';
            messageBox.style.opacity = 0;
            scoreDisplay.textContent = `Score: ${score}`;
            scoreDisplay.style.opacity = 1;
            highScoreDisplay.style.opacity = 1;
            finalScoreDisplay.style.display = 'none';
        }

        /**
         * Triggers the end sequence, starting the celebration/failure animation.
         */
        function endGame() {
            if (gameState === 'animating' || gameState === 'over') return; 

            gameState = 'animating';
            endAnimationStartTime = performance.now() / 1000;
            setHighScore(score);

            // Determine celebration or failure
            if (score > HIGH_SCORE_THRESHOLD) {
                endAnimationType = 'celebrate';
                statusMessageIngame.textContent = `Excellent work! Scoring ${score} is a major scoop!`;
            } else {
                endAnimationType = 'fail';
                statusMessageIngame.textContent = `Rethink your sources. Final Score: ${score}.`;
            }

            messageBox.style.opacity = 1; // Keep the message box visible for the animation text
            headlineDisplay.textContent = "GAME OVER";
        }
        
        /**
         * Displays the final UI screen after the animation concludes.
         */
        function showGameOverScreen() {
            gameState = 'over';

            // Show Game Over UI
            overlay.style.display = 'flex';
            messageBox.style.display = 'none';
            statusMessage.textContent = endAnimationType === 'celebrate' ? 
                                        "You're a trusted source! Great job on fact-checking." :
                                        "The misinformation caught up to you...";
            headlineDisplay.textContent = "";
            finalScoreDisplay.textContent = `Final Score: ${score}`;
            finalScoreDisplay.style.display = 'block';
            startButton.textContent = "Play Again";
            
            // Hide in-game score
            scoreDisplay.style.opacity = 0;
            highScoreDisplay.style.opacity = 0;
        }

        // --- 4. WORLD GENERATION ---

        function addTile(z) {
            const tileGroup = new THREE.Group();

            // 1. Floor Geometry (3 lanes)
            const floorGeometry = new THREE.BoxGeometry(TILE_WIDTH * 3 + 0.5, TILE_HEIGHT, TILE_DEPTH);
            const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x1a1a40 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.position.set(0, -TILE_HEIGHT / 2, 0);
            tileGroup.add(floor);

            // 2. Neon Lane Dividers (Yellow)
            for (let i = 0; i < 2; i++) {
                const dividerGeometry = new THREE.BoxGeometry(0.1, TILE_HEIGHT, TILE_DEPTH);
                const dividerMaterial = new THREE.MeshBasicMaterial({ color: 0xffcc00 });
                const divider = new THREE.Mesh(dividerGeometry, dividerMaterial);
                divider.position.set(LANE_POSITIONS[i] + LANE_WIDTH / 2, 0, 0);
                tileGroup.add(divider);
            }

            // 3. Walls
            const wallHeight = 10;
            const wallMaterial = new THREE.MeshBasicMaterial({ color: 0x2e2e5c });

            const leftWallGeometry = new THREE.BoxGeometry(0.5, wallHeight, TILE_DEPTH);
            const leftWall = new THREE.Mesh(leftWallGeometry, wallMaterial);
            leftWall.position.set(-(TILE_WIDTH * 1.5 + 0.25), wallHeight / 2, 0);
            tileGroup.add(leftWall);

            const rightWallGeometry = new THREE.BoxGeometry(0.5, wallHeight, TILE_DEPTH);
            const rightWall = new THREE.Mesh(rightWallGeometry, wallMaterial);
            rightWall.position.set((TILE_WIDTH * 1.5 + 0.25), wallHeight / 2, 0);
            tileGroup.add(rightWall);

            // 4. Headline Obstacle Generation
            if (z <= nextHeadlineTileZ) {
                spawnHeadlineObstacle(tileGroup);
                nextHeadlineTileZ = z - HEADLINE_ADVANCE_DISTANCE;
            }

            tileGroup.position.z = z;
            scene.add(tileGroup);
            tiles.push(tileGroup);
        }

        function spawnHeadlineObstacle(tileGroup) {
            let availableHeadlines = HEADLINES.filter(h => !headlineQueue.some(q => q.headline.headline === h.headline));
            
            if (availableHeadlines.length === 0) {
                availableHeadlines = HEADLINES.slice();
            }

            const randomIndex = Math.floor(Math.random() * availableHeadlines.length);
            const headlineData = availableHeadlines[randomIndex];

            const correctLaneIndex = headlineData.isReal ? 2 : 0;
            const obstacleZ = -TILE_DEPTH / 2 + 5;

            // Invisible trigger wall
            const triggerGeometry = new THREE.BoxGeometry(TILE_WIDTH * 3, TILE_HEIGHT * 10, 0.5); 
            const triggerMaterial = new THREE.MeshBasicMaterial({ transparent: true, opacity: 0 }); 
            const trigger = new THREE.Mesh(triggerGeometry, triggerMaterial);
            trigger.position.set(0, 0, obstacleZ);
            trigger.userData = { 
                isTrigger: true, 
                correctLaneIndex: correctLaneIndex,
                headline: headlineData 
            };
            tileGroup.add(trigger);

            // VISUAL gates
            const gateHeight = 4;
            const gateGeometry = new THREE.BoxGeometry(LANE_WIDTH - 0.5, gateHeight, 0.5);
            
            // FAKE Gate (Left Lane)
            const fakeGateMaterial = new THREE.MeshBasicMaterial({ color: 0xff3300 });
            const fakeGate = new THREE.Mesh(gateGeometry, fakeGateMaterial);
            fakeGate.position.set(LANE_POSITIONS[0], gateHeight / 2, obstacleZ);
            tileGroup.add(fakeGate);

            // REAL Gate (Right Lane)
            const realGateMaterial = new THREE.MeshBasicMaterial({ color: 0x33ff00 });
            const realGate = new THREE.Mesh(gateGeometry, realGateMaterial);
            realGate.position.set(LANE_POSITIONS[2], gateHeight / 2, obstacleZ);
            tileGroup.add(realGate);
            
            // Store the data for player checks
            headlineQueue.push({
                headline: headlineData,
                tile: tileGroup,
                trigger: trigger,
                correctLaneIndex: correctLaneIndex,
                passed: false
            });
        }


        // --- 5. GAME LOOP AND UPDATES ---

        function animate(time) {
            requestAnimationFrame(animate);
            
            const timeSeconds = time / 1000;
            const deltaTime = timeSeconds - (animate.lastTime || timeSeconds);
            animate.lastTime = timeSeconds;

            if (gameState === 'running') {
                const deltaZ = playerSpeed;

                // 1. Move the world
                tiles.forEach(tile => {
                    tile.position.z += deltaZ;

                    if (tile.position.z > 50) { 
                        scene.remove(tile);
                        tiles.shift();
                        
                        if (tiles.length > 0) {
                            addTile(tiles[tiles.length - 1].position.z - TILE_DEPTH); 
                            playerSpeed += 0.002;
                        } else {
                            addTile(-TILE_DEPTH);
                        }
                    }
                });

                // 2. Player Movement Update
                if (isMoving) {
                    const elapsed = timeSeconds - moveStartTime;
                    const t = Math.min(1, elapsed / moveDuration);
                    player.position.x = THREE.MathUtils.lerp(player.position.x, targetX, t);
                    
                    if (t === 1) {
                        isMoving = false;
                        player.position.x = targetX;
                    }
                }

                // 3. Collision and Scoring Check
                checkHeadlineCollision();
            } else if (gameState === 'animating') {
                // Character Celebration/Failure Animation
                const elapsed = timeSeconds - endAnimationStartTime;
                const progress = elapsed / endAnimationDuration;

                if (progress < 1) {
                    if (endAnimationType === 'celebrate') {
                        // Slow, happy spin
                        player.rotation.y += deltaTime * 5; // Spin faster
                        
                    } else if (endAnimationType === 'fail') {
                        // Quick wobble/tilt
                        const wobble = Math.sin(elapsed * 15) * 0.2;
                        player.rotation.z = wobble;
                    }
                } else {
                    // Animation finished, show Game Over screen
                    player.rotation.set(0, 0, 0); // Reset final rotation
                    showGameOverScreen();
                }
            }

            // Render the 3D scene
            renderer.render(scene, camera);
        }
        animate.lastTime = 0; // Initialize last time tracker

        function checkHeadlineCollision() {
            const nextHeadline = headlineQueue[0];
            
            if (!nextHeadline || nextHeadline.passed) {
                if (messageBox.style.opacity !== "0") {
                     headlineDisplay.textContent = "";
                     statusMessageIngame.textContent = ""; 
                     messageBox.style.opacity = 0;
                }
                return;
            }

            const triggerZ = nextHeadline.tile.position.z + nextHeadline.trigger.position.z;
            
            // FIX: Missed Gate Detection (If the gate passes the camera, you failed to choose)
            if (triggerZ > player.position.z + 5) { 
                endGame();
                nextHeadline.passed = true;
                headlineQueue.shift();
                currentHeadline = null; 
                return; 
            }

            // a) Display headline when player is approaching
            const displayDistance = 80; 
            if (triggerZ > player.position.z - displayDistance && triggerZ < player.position.z) {
                 if (currentHeadline !== nextHeadline) {
                    currentHeadline = nextHeadline;
                    headlineDisplay.textContent = nextHeadline.headline.headline;
                    statusMessageIngame.textContent = "Make your choice! (Fake = Left, Real = Right)";
                    messageBox.style.opacity = 1; 
                }
            }
            
            // b) Check for passing point (when player crosses the trigger's Z)
            if (triggerZ > player.position.z - (playerSpeed / 2) && 
                triggerZ < player.position.z + (playerSpeed / 2)) 
            {
                const playerLane = LANE_POSITIONS.indexOf(Math.round(player.position.x));
                const isCorrect = playerLane === nextHeadline.correctLaneIndex;

                if (isCorrect) {
                    score++;
                    scoreDisplay.textContent = `Score: ${score}`;
                } else {
                    // Game Over: Incorrect lane selected OR stayed in the middle lane (1)
                    endGame();
                }
                
                nextHeadline.passed = true;
                headlineQueue.shift(); 
                currentHeadline = null;
            }
        }

        // --- 6. INPUT HANDLER ---

        function onKeyDown(event) {
            if (gameState !== 'running' || isMoving) return;

            let newLane = currentLane;
            let moved = false;

            if (event.key === 'ArrowLeft') {
                newLane = 0;
                moved = newLane !== currentLane;
            } else if (event.key === 'ArrowRight') {
                newLane = 2;
                moved = newLane !== currentLane;
            } else if (event.key === 'ArrowDown') {
                newLane = 1;
                moved = newLane !== currentLane;
            }

            if (moved) {
                currentLane = newLane;
                targetX = LANE_POSITIONS[currentLane];
                isMoving = true;
                moveStartTime = performance.now() / 1000;
            }
        }

        window.onload = init;
    </script>
</body>
</html>
